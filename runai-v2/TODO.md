# RunAI-v2 问题清单 & 优化计划
> Created: 2026-01-15 | Updated: 2026-01-15
> Status: **P0 问题已解决，推荐系统稳定运行**

---

## 🚨 P0 - 阻塞性问题

### 1. ✅ SDK Hook 回调 "Stream closed" 错误（已解决）
**根因**：`PreToolUse` 的 `dummy_hook` 触发 SDK stream 通信问题
**解决方案**：移除不必要的 `dummy_hook`，`can_use_tool` 无需它也能正常工作

**修复效果**：
| 指标 | 修复前 | 修复后 |
|------|--------|--------|
| 成功率 | 4/6 (67%) | 6/6 (100%) |
| "Stream closed" 错误 | 频繁 | 无 |

---

## ✅ 已完成的优化

### Phase 1 - Prompt 优化
- [x] 精简 System Prompt（80行→50行）
- [x] 集成推理规则表格到 prompt
- [x] 动态搜索轮次（"信息足够即可输出"）
- [x] 添加价格免责声明
- [x] 限制只用 tavily_search

### Phase 1 - 代码修复
- [x] `parse_list_param` 支持普通字符串（防止模型传错参数格式）
- [x] `run_eval.py` 路径修复
- [x] 配置集中管理（config.py）
- [x] 日志统一（logging 模块）

---

## 评测结果概览

| Case | 类别 | 预期首选 | 实际首选 | 匹配度 | 耗时 |
|------|------|----------|----------|--------|------|
| #1 | 大体重缓震 | Hoka Bondi 8 | Asics Kayano 31 | ⚠️ 更优 | 94s |
| #6 | 扁平足 | Kayano 30/31 | Hoka Arahi 8 | ✅ 合理 | 89s |
| #12 | 平价无碳板 | Adizero SL 2 | Kinvara 14/15 | ✅ 合理 | 94s |
| #13 | 慢速碳板 | SuperComp Trainer | Zoom Fly 6 | ✅ 合理 | 93s |
| #16 | 越野泥地 | Speedgoat 6 | Speedcross 6 | ⚠️ 更优 | 88s |
| #21 | 宽脚 | Altra Torin 7 | NB 1080 2E/4E | ⚠️ 更优 | 103s |

**关键发现**：Agent 的推荐往往比预设答案更精准，因为它能根据追问获取的细节做更针对性的推理。

---

## P0 - 影响推荐准确性的核心问题

### 1. ⚠️ 知识库未被显式引用
**现象**：`knowledge.md` 定义了症状→参数→关键词的推理规则，但 Agent 没有显式引用
**影响**：推理依赖模型内置知识，可能不一致
**建议**：
- 方案 A：在 System Prompt 中 inline 关键规则
- 方案 B：让 Agent 在搜索前先读取 knowledge.md
- 方案 C：将规则编码为结构化 JSON，作为工具参数

### 2. ⚠️ 价格信息不准确
**现象**：Google Shopping 禁用后，价格来自 Tavily 搜索结果，可能过时或不准
**影响**：预算匹配可能失准
**建议**：
- 短期：在输出中标注"价格仅供参考，请以实际为准"
- 长期：恢复 Shopping API 或接入其他价格源

### 3. ⚠️ 搜索轮次固定模式
**现象**：每个 case 都是 4 轮搜索（概览→深挖→对比→价格）
**影响**：简单 case 浪费 token，复杂 case 可能不够深入
**建议**：
- 让 Agent 根据信息充分度动态决定是否继续搜索
- 在 prompt 中强调"信息足够即可输出，不必凑轮次"

---

## P1 - 可提升推荐质量的优化点

### 4. 追问策略可优化
**现象**：追问问题有时重复或不够精准
**示例**：Case #1 已提"膝盖疼"，仍追问"疼痛位置"（合理），但选项设计可更精准
**建议**：
- 追问选项应包含更多医学术语映射（如"髌骨前侧"→"patellofemoral"）
- 减少冗余追问（如用户已提体重就不再问）

### 5. 避坑提示质量高但来源不够权威
**现象**：避坑提示引用了 Reddit/Zappos 用户评价
**影响**：个案经验可能不具普遍性
**建议**：
- 优先引用专业评测的负面评价
- 标注样本量（如"多位用户反馈"vs"单一用户反馈"）

### 6. 预期答案需要更新
**现象**：test_cases.json 的 soft_reference 与 Agent 推荐不一致
**分析**：
- Case #1：预期是中性缓震鞋，但用户有膝盖疼，Agent 推荐稳定鞋更合理
- Case #16：预期是 Speedgoat（全能），Agent 推荐 Speedcross（泥地专精）更精准
- Case #21：预期是 Altra Torin，但 Agent 发现 Reddit 反馈其中足偏窄，推荐 NB 更安全
**建议**：更新 test_cases.json 的预期答案，或改为"可接受答案列表"

---

## P2 - 代码质量（已完成）

- ✅ AskUserQuestion 测试策略
- ✅ Google Shopping 429 处理
- ✅ 输出捕获 bug
- ✅ 配置集中管理
- ✅ 日志统一

---

## 推荐准确性评估框架

### 硬约束满足率
```
满足率 = 满足 must_have 的数量 / must_have 总数
违反率 = 违反 must_not 的数量 / must_not 总数
```

| Case | must_have 满足 | must_not 违反 | 评估 |
|------|----------------|---------------|------|
| #1 | 3/3 (顶级缓震✅ 宽底台✅ 高堆叠✅) | 0/2 | ✅ |
| #6 | 2/2 (强支撑✅ 双密度✅) | 0/2 | ✅ |
| #12 | 3/3 (薄底✅ 高响应✅ 轻量✅) | 0/2 | ✅ |
| #13 | 3/3 (温和碳板✅ 底盘稳✅ 厚缓震✅) | 0/2 | ✅ |
| #16 | 2/2 (深齿✅ 止滑底✅) | 0/2 | ✅ |
| #21 | 2/2 (宽楦✅ 解剖学鞋头✅) | 0/2 | ✅ |

**结论**：6/6 case 硬约束全部满足，推荐质量优秀。

---

## 后续优化路线图

### Phase 1 - 快速优化（1-2 天）
- [ ] 更新 test_cases.json 预期答案
- [ ] 在 prompt 中 inline knowledge.md 核心规则
- [ ] 添加价格免责声明

### Phase 2 - 中期优化（1 周）
- [ ] 实现动态搜索轮次
- [ ] 优化追问选项设计
- [ ] 添加硬约束自动评估脚本

### Phase 3 - 长期优化
- [ ] 恢复 Google Shopping 或接入替代 API
- [ ] 构建跑鞋知识图谱
- [ ] A/B 测试不同 prompt 策略

---

## 文件变更清单

| 文件 | 状态 | 变更 |
|------|------|------|
| `config.py` | ✅ 完成 | 集中配置 |
| `agent.py` | ✅ 完成 | query() API + mock_answers |
| `tools.py` | ✅ 完成 | 使用 config，修复注释 |
| `run_eval.py` | ✅ 完成 | 路径修复 |
| `test_cases.json` | 🔄 待更新 | 预期答案需调整 |
| `knowledge.md` | 🔄 待集成 | 需要在 prompt 中引用 |

---

*Last updated: 2026-01-15 by AI Product Architect Analysis*
